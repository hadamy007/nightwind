<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat statico</title>
  <style>
    body {
      font-family: 'Georgia', serif; /* stile carattere aggiornato */
      margin: 0;
      background: #f5f5f5;
    }

    #chat-container {
      width: 100vw;
      height: 100vh;
      border: none;
      border-radius: 0;
      background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 50%, #b2fefa 100%); /* sfumature di blu */
      display: flex;
      flex-direction: column;
      box-shadow: none;
    }

    #messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      padding: 8px 12px;
      border-radius: 20px;
      max-width: 80%;
      word-wrap: break-word;
      font-style: italic; /* aggiunta di uno stile per rendere evidente il cambiamento */
    }

    .user {
      align-self: flex-end;
      background: #ffc0cb; /* rosa */
    }

    .bot {
      align-self: flex-start;
      background: #000; /* sfondo nero */
      color: #fff; /* testo bianco per contrasto */
    }

    #input-area {
      display: flex;
      border-top: 1px solid #ccc;
      position: relative;
    }

    #input-area input {
      flex: 1;
      padding: 12px;
      border: none;
      outline: none;
      font-size: 1rem;
    }

    #input-area button {
      padding: 0 16px;
      border: none;
      background: #ff69b4; /* rosa */
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }

    #input-area button:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <h1 style="text-align:center; margin:16px 0; font-size:1.5rem;">IL mio amico â¤ï¸â¤ï¸</h1>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="ğŸ” Scrivi un messaggio... ğŸ˜„" />
      <button id="emoji-btn" title="Scegli emoji">ğŸ˜Š</button>
      <button id="photo-btn" title="Scatta foto">ğŸ“·</button>
      <button id="record-btn" title="Registra audio">ğŸ¤</button>
      <button id="send-btn" disabled>Invia</button>
    </div>
    <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none" />
    <div id="emoji-picker" style="display:none; position:absolute; bottom:50px; left:10px; background:#fff; border:1px solid #ccc; padding:8px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
      <!-- emoji options -->
      ğŸ˜‚ ğŸ˜‚ â¤ï¸ ğŸ˜ ğŸ¤” ğŸ™Œ ğŸ‘ ğŸ‘ ğŸ‰
    </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function appendMessage(text, sender, audioUrl, imageUrl) {
      const msg = document.createElement('div');
      msg.classList.add('message', sender);
      if (imageUrl) {
        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.maxWidth = '100%';
        msg.appendChild(img);
        if (text) {
          const span = document.createElement('span');
          span.textContent = text;
          msg.appendChild(span);
        }
      } else if (audioUrl) {
        const audio = document.createElement('audio');
        audio.src = audioUrl;
        audio.controls = true;
        msg.appendChild(audio);
        if (text) {
          const span = document.createElement('span');
          span.textContent = text;
          msg.appendChild(span);
        }
      } else {
        msg.textContent = text;
      }
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function botReply(userText) {
      // rispondi logicamente usando l'AI per ogni input; manteniamo alcune risposte personalizzate
      const txt = userText.toLowerCase().trim();
      let response;
      if (txt === 'sofia puzza') {
        response = ' sono completamente d\'accordo con te';
      } else if (txt === 'jacopo Ã¨ brutto' || txt === 'jacopo e\' brutto' || txt === 'jacopo Ã¨ brutto') {
        response = ' hai ragione, Jacopo fusci Ã¨ bruttissimo';
      } else if (txt === 'hadamy Ã¨ brutta' || txt === 'hadamy e\' brutta') {
        response = ' no, Ã¨ bellissima';
      } else if (txt === 'sei bella') {
        response = 'grazie â¤ï¸â¤ï¸';
      } else {
        // per tutto il resto, affidiamoci all'AI per ottenere una risposta sensata
        response = await getAIResponse(userText);
      }
      appendMessage(response, 'bot');
    }

    sendBtn.addEventListener('click', () => {
      const text = inputEl.value.trim();
      if (!text) return;
      appendMessage(text, 'user');
      inputEl.value = '';
      sendBtn.disabled = true;
      // simuliamo una piccola attesa
      setTimeout(() => botReply(text), 300);
    });

    inputEl.addEventListener('input', () => {
      sendBtn.disabled = inputEl.value.trim() === '';
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendBtn.click();
      }
    });

    // emoji picker
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.getElementById('emoji-picker');
    emojiBtn.addEventListener('click', () => {
      emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });
    emojiPicker.addEventListener('click', (e) => {
      if (e.target.textContent) {
        inputEl.value += e.target.textContent;
        sendBtn.disabled = inputEl.value.trim() === '';
      }
    });

    // close picker when clicking outside
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = 'none';
      }
    });

    // audio recording
    let mediaRecorder;
    let audioChunks = [];
    const recordBtn = document.getElementById('record-btn');
    recordBtn.addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            appendMessage('', 'user', null, null, url);
            // trigger bot reply normally
            sendBotReply();
          };
          mediaRecorder.start();
          recordBtn.textContent = 'â¹ï¸';
        } catch (err) {
          console.error('Microfono non accessibile', err);
        }
      } else {
        mediaRecorder.stop();
        recordBtn.textContent = 'ğŸ¤';
      }
    });
    
    // photo capture
    const photoBtn = document.getElementById('photo-btn');
    const photoInput = document.getElementById('photo-input');
    photoBtn.addEventListener('click', () => {
      photoInput.click();
    });
    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        appendMessage('', 'user', null, url);
        sendBotReply();
      }
    });

    function sendBotReply() {
      // reuse existing logic by calling with dummy text
      setTimeout(() => botReply(''), 300);
    }

    async function getAIResponse(prompt) {
      // utilzza l'API OpenAI ChatCompletion; imposta la variabile OPENAI_API_KEY con la tua chiave
      try {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (window.OPENAI_API_KEY || ''),
          },
          body: JSON.stringify({
            model: 'gpt-4',
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 150,
          }),
        });
        const data = await res.json();
        if (data && data.choices && data.choices[0].message) {
          return data.choices[0].message.content.trim();
        }
      } catch (e) {
        console.error('Errore AI', e);
      }
      // se qualcosa va storto, restituiamo una risposta presumibilmente utile
      return 'Sto ancora imparando, riprova tra un momento.';
    }

    // focus on page load
    inputEl.focus();
  </script>
</body>
</html>